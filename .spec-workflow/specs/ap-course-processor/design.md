# æŠ€æœ¯è®¾è®¡æ–‡æ¡£ - AP è¯¾ç¨‹å¤„ç†å·¥å…·

## 1. ç³»ç»Ÿæ¶æ„

### 1.1 æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æµè§ˆå™¨                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¸Šä¼ ç»„ä»¶    â”‚  â”‚  é¢„è§ˆç»„ä»¶    â”‚  â”‚  å¯¹ç…§ç»„ä»¶    â”‚  â”‚
â”‚  â”‚ (PDF+JSON)   â”‚  â”‚  (JSONæ ‘)    â”‚  â”‚ (PDF/JSON)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                 â”‚                  â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                          â”‚                                â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚ App Router â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                          â”‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Next.js          â”‚         æœåŠ¡ç«¯                 â”‚
â”‚                          â”‚                                â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚ API Routes â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                          â”‚                                â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                â”‚                â”‚              â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”        â”‚
â”‚    â”‚ JSONè¯»å–â”‚    â”‚ æ•°æ®è®¡ç®—  â”‚   â”‚ JSONåˆå¹¶  â”‚        â”‚
â”‚    â”‚ æœåŠ¡    â”‚    â”‚ æœåŠ¡      â”‚   â”‚ è¾“å‡ºæœåŠ¡  â”‚        â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å…¥ï¼š
- PDF æ–‡ä»¶ï¼ˆç”¨äºå±•ç¤ºå¯¹ç…§ï¼‰
- JSON æ–‡ä»¶ï¼ˆæå–çš„åŸå§‹è¯¾ç¨‹ç»“æ„æ•°æ®ï¼‰

è¾“å‡ºï¼š
- å®Œæ•´ JSONï¼ˆåŸå§‹æ•°æ® + è®¡ç®—æ•°æ®ï¼‰
```

### 1.2 æŠ€æœ¯æ ˆé€‰å‹

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ | ç†ç”± |
|------|------|------|------|
| æ¡†æ¶ | Next.js | 15+ | App Routerã€æœåŠ¡ç«¯ç»„ä»¶ã€API Routes |
| è¯­è¨€ | TypeScript | 5+ | ç±»å‹å®‰å…¨ã€å¼€å‘ä½“éªŒ |
| æ ·å¼ | Tailwind CSS | 3+ | å¿«é€Ÿå¼€å‘ã€å“åº”å¼è®¾è®¡ |
| UIç»„ä»¶ | shadcn/ui | Latest | é«˜è´¨é‡ç»„ä»¶ã€å¯å®šåˆ¶ |
| PDFæ¸²æŸ“ | react-pdf | 10+ | æˆç†Ÿç¨³å®šã€Reacté›†æˆå¥½ |
| PDFè§£æ | pdf-parse | Latest | Node.jsåŸç”Ÿã€è½»é‡çº§ |
| ä»£ç ç¼–è¾‘å™¨ | Monaco Editor | Latest | VSCodeåŒæ¬¾ã€å¼ºå¤§ |
| çŠ¶æ€ç®¡ç† | Zustand | Latest | è½»é‡ã€ç®€å• |
| è¡¨å•å¤„ç† | React Hook Form | Latest | æ€§èƒ½ä¼˜ç§€ |
| æ•°æ®éªŒè¯ | Zod | Latest | TypeScriptä¼˜å…ˆ |

## 2. æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 TypeScript ç±»å‹å®šä¹‰

```typescript
// src/types/course.ts

/**
 * è¯¾ç¨‹å®Œæ•´æ•°æ®ç»“æ„
 * éµå¾ª College Board CED æ–‡æ¡£å’Œ Gemini æå–çš„å®é™…æ ¼å¼
 */
export interface APCourse {
  course_name: string;
  units: APUnit[];
  metadata?: CourseMetadata;
  // Phase 4: æœ€ç»ˆç»Ÿè®¡æ•°æ®
  image_statistics?: ImageStatistics;
}

/**
 * è¯¾ç¨‹å…ƒæ•°æ®
 */
export interface CourseMetadata {
  extracted_at: string;
  pdf_file_name: string;
  pdf_page_count: number;
  version: string;
}

/**
 * å•å…ƒæ•°æ®
 */
export interface APUnit {
  unit_number: number;
  unit_title: string;
  ced_class_periods: string; // æ ¼å¼: "~8 Class Periods"
  exam_weight: string; // æ ¼å¼: "4-6%"
  topics: APTopic[];
  // AI ç”Ÿæˆçš„å•å…ƒæµ‹è¯•ï¼ˆä» Topic Quiz ç¼–è¯‘è€Œæˆï¼‰
  unit_test?: UnitTest;
}

/**
 * å•å…ƒæµ‹è¯•æ•°æ®ï¼ˆPhase 3 ç”Ÿæˆï¼‰
 */
export interface UnitTest {
  unit_number: number;
  test_title: string;         // æ ¼å¼: "Unit 1 Test"
  questions: QuizQuestion[];  // 15-20 é¢˜ï¼Œä» Topic Quiz ä¸­é€‰å–
  total_questions: number;
  estimated_minutes: number;  // å»ºè®®æµ‹è¯•æ—¶é•¿
}

/**
 * ä¸»é¢˜æ•°æ®
 */
export interface APTopic {
  topic_number: string; // æ ¼å¼: "1.1"
  topic_title: string;
  learning_objectives: LearningObjective[];
  essential_knowledge: EssentialKnowledge[];
  // AI ç”Ÿæˆçš„å­¦ä¹ å†…å®¹
  topic_estimated_minutes?: number;
  learn?: {
    minutes: number;
    study_guide_words: number;
  };
  review?: {
    minutes: number;
    flashcards_count: number;
  };
  practice?: {
    minutes: number;
    quiz_count: number;
  };
  study_guide?: string;
  flashcards?: Flashcard[];
  quiz?: QuizQuestion[];
}

/**
 * é—ªå¡æ•°æ®
 */
export interface Flashcard {
  front: string;
  back: string;
  requires_image: boolean; // æ˜¯å¦éœ€è¦é…å›¾
}

/**
 * æµ‹éªŒé¢˜ç›®æ•°æ®
 */
export interface QuizQuestion {
  question: string;
  options: string[];          // æ ¼å¼: ["A. ...", "B. ...", "C. ...", "D. ..."]
  correct_answer: string;     // æ ¼å¼: "A", "B", "C", or "D"
  explanation: string;
  requires_image: boolean;    // æ˜¯å¦éœ€è¦é…å›¾
}

/**
 * å­¦ä¹ ç›®æ ‡
 */
export interface LearningObjective {
  id: string; // æ ¼å¼: "Unit 1: Learning Objective A"
  summary: string;
}

/**
 * åŸºæœ¬çŸ¥è¯†
 */
export interface EssentialKnowledge {
  id: string; // æ ¼å¼: "KC-1.1" æˆ– "KC-1.1.I.A"
  summary: string;
}

/**
 * å›¾åƒéœ€æ±‚ç»Ÿè®¡ï¼ˆPhase 4 ç”Ÿæˆï¼‰
 */
export interface ImageStatistics {
  // Flashcards
  total_flashcards: number;
  flashcards_requiring_images: number;
  flashcards_image_percentage: number;
  
  // Topic Quiz
  total_topic_quiz_questions: number;
  topic_quiz_requiring_images: number;
  topic_quiz_image_percentage: number;
  
  // Unit Tests
  total_unit_test_questions: number;
  unit_test_requiring_images: number;
  unit_test_image_percentage: number;
  
  // æ€»è®¡
  total_items: number;
  total_requiring_images: number;
  overall_image_percentage: number;
}

/**
 * ä¸Šä¼ çŠ¶æ€
 */
export interface UploadState {
  status: 'idle' | 'uploading' | 'processing' | 'success' | 'error';
  progress: number;
  message?: string;
  error?: string;
}

/**
 * è§£æç»“æœ
 */
export interface ParseResult {
  success: boolean;
  data?: APCourse;
  error?: string;
  warnings?: string[];
}
```

### 2.2 Zod éªŒè¯æ¨¡å¼

```typescript
// src/lib/validators.ts
import { z } from 'zod';

export const LearningObjectiveSchema = z.object({
  id: z.string().min(1), // æ ¼å¼: "Unit 1: Learning Objective A"
  summary: z.string().min(10),
});

export const EssentialKnowledgeSchema = z.object({
  id: z.string().min(1), // æ ¼å¼: "KC-1.1" æˆ– "KC-1.1.I.A"
  summary: z.string().min(10),
});

export const APTopicSchema = z.object({
  topic_number: z.string().regex(/^\d+\.\d+$/), // æ ¼å¼: "1.1"
  topic_title: z.string().min(3),
  learning_objectives: z.array(LearningObjectiveSchema),
  essential_knowledge: z.array(EssentialKnowledgeSchema),
});

export const APUnitSchema = z.object({
  unit_number: z.number().int().positive(),
  unit_title: z.string().min(3),
  ced_class_periods: z.string().regex(/^~\d+\s+Class\s+Periods$/), // æ ¼å¼: "~8 Class Periods"
  exam_weight: z.string().regex(/^\d+-\d+%$/), // æ ¼å¼: "4-6%"
  topics: z.array(APTopicSchema),
});

export const APCourseSchema = z.object({
  course_name: z.string().min(3),
  units: z.array(APUnitSchema),
  metadata: z.object({
    extracted_at: z.string(),
    pdf_file_name: z.string(),
    pdf_page_count: z.number(),
    version: z.string(),
  }).optional(),
});
```

## 3. AI å†…å®¹ç”Ÿæˆé€»è¾‘

### 3.1 å›¾åƒæ ‡è®°è§„åˆ™ï¼ˆImage Flaggingï¼‰

> **é€‚ç”¨èŒƒå›´**ï¼šPhase 2 å’Œ Phase 3
> - Phase 2: ä¸ºæ–°ç”Ÿæˆçš„ flashcards å’Œ quiz questions æ·»åŠ  requires_image
> - Phase 3: ç¼–è¯‘ unit test æ—¶ä¿ç•™åŸé¢˜çš„ requires_image æ ‡è®°

AI ç”Ÿæˆå™¨åœ¨åˆ›å»º flashcards å’Œ quiz questions æ—¶ï¼Œå¿…é¡»ä¸ºæ¯ä¸ªé¡¹ç›®æ·»åŠ  `requires_image` æ ‡å¿—ã€‚

#### 3.1.1 Quiz Questions å›¾åƒåˆ¤æ–­è§„åˆ™

å°† `requires_image` è®¾ç½®ä¸º `true` çš„æƒ…å†µï¼š
- é—®é¢˜è¦æ±‚ç”¨æˆ·è§£è¯»å›¾è¡¨ã€å›¾å½¢ã€åœ°å›¾æˆ–æ•°æ®è¡¨
- é—®é¢˜å¼•ç”¨ç‰¹å®šçš„å›¾ç¤ºã€è‰ºæœ¯ä½œå“ã€ç»“æ„æˆ–è§†è§‰æ¨¡å‹
  - ä¾‹å¦‚ï¼š"Based on the diagram of the cell..."
  - ä¾‹å¦‚:"Which artist painted the work shown..."
- é—®é¢˜åŸºäºåˆºæ¿€ææ–™ï¼ˆstimulus-basedï¼‰ï¼Œéœ€è¦åŸå§‹æ–‡æ¡£ã€æ¼«ç”»æˆ–ç…§ç‰‡æ‰èƒ½ç†è§£
- é—®é¢˜æ¶‰åŠç©ºé—´æ¨ç†ï¼Œå›¾åƒå¯ä»¥å¸®åŠ©ç†è§£ï¼ˆå¦‚åˆ†å­å‡ ä½•ã€ç‰©ç†åŠ›å›¾ï¼‰

#### 3.1.2 Flashcards å›¾åƒåˆ¤æ–­è§„åˆ™

å°† `requires_image` è®¾ç½®ä¸º `true` çš„æƒ…å†µï¼š
- æ­£é¢æ˜¯è§†è§‰æ¦‚å¿µçš„æœ¯è¯­ï¼ˆå¦‚"Doric Column"ã€"Mitochondrion"ã€"Tectonic Plates Map"ï¼‰
  - å›¾åƒåº”æ”¾åœ¨èƒŒé¢ä¸å®šä¹‰ä¸€èµ·
- æ­£é¢æ˜¯å®šä¹‰ï¼ŒèƒŒé¢æ˜¯è§†è§‰å¯¹è±¡çš„åç§°

#### 3.1.3 ç¤ºä¾‹æ•°æ®

```json
{
  "flashcards": [
    {
      "front": "Cohesion",
      "back": "The property of water molecules sticking to each other due to hydrogen bonds.",
      "requires_image": false
    },
    {
      "front": "Mitochondrion",
      "back": "The powerhouse of the cell, responsible for ATP production.",
      "requires_image": true
    }
  ],
  "quiz": [
    {
      "question": "Which property of water is most directly responsible for the transport of water from roots to leaves?",
      "options": ["A. Polarity", "B. Cohesion", "C. High specific heat", "D. Expansion upon freezing"],
      "correct_answer": "B",
      "explanation": "Cohesion allows water molecules to stick together, creating a continuous column for transport.",
      "requires_image": false
    },
    {
      "question": "Based on the provided Lewis diagram, what is the molecular geometry of the species?",
      "options": ["A. Tetrahedral", "B. Linear", "C. Bent", "D. Trigonal planar"],
      "correct_answer": "A",
      "explanation": "The molecule has four bonding regions and no lone pairs, resulting in tetrahedral geometry.",
      "requires_image": true
    }
  ]
}
```

### 3.2 å†…å®¹ç”Ÿæˆå·¥ä½œæµ

```
Phase 1: Quantitative Planning (ä½¿ç”¨ JSON)
  â”œâ”€ åˆ†æè¯¾ç¨‹ç±»å‹ï¼ˆA/B/Cï¼‰
  â”œâ”€ åˆ†é…å‚æ•°ï¼ˆå­¦ä¹ é€Ÿåº¦ã€æ¯æ—¥æ—¶é•¿ï¼‰
  â”œâ”€ è®¡ç®—å†…å®¹æ•°é‡ï¼ˆtarget_mcq, target_flashcards, target_sg_wordsï¼‰
  â””â”€ è®¡ç®—æ¯ä¸ª Topic çš„å­¦ä¹ æ—¶é•¿

Phase 2: Iterative Content Generation (ä½¿ç”¨ JSON å’Œ PDF)
  â”œâ”€ ä¸ºæ¯ä¸ª Topic ç”Ÿæˆ Study Guide
  â”œâ”€ ç”Ÿæˆ Flashcardsï¼ˆå« requires_image æ ‡è®°ï¼‰
  â”œâ”€ ç”Ÿæˆ Quiz Questionsï¼ˆå« requires_image æ ‡è®°ï¼‰
  â””â”€ æ³¨æ„ï¼šrequires_image éµå¾ª 3.1 èŠ‚å®šä¹‰çš„åˆ¤æ–­è§„åˆ™

Phase 3: Unit Test Compilation (ä½¿ç”¨å·²ç”Ÿæˆçš„ Topic Quiz)
  â”œâ”€ ä»æ‰€æœ‰ Topic Quiz ä¸­éšæœºé€‰å–é¢˜ç›®
  â”œâ”€ ç¼–è¯‘æˆ Unit-level ç»¼åˆæµ‹è¯•
  â”œâ”€ ä¿ç•™åŸé¢˜çš„ requires_image æ ‡è®°
  â””â”€ æ¯ä¸ª Unit Test åŒ…å« 15-20 é“é¢˜

Phase 4: Final Assembly
  â”œâ”€ ç»„è£…å®Œæ•´è¯¾ç¨‹æ•°æ®
  â”œâ”€ éªŒè¯æ‰€æœ‰ flashcards å’Œ quiz questions éƒ½æœ‰ requires_image å­—æ®µ
  â”œâ”€ ç»Ÿè®¡å›¾åƒéœ€æ±‚ï¼ˆéœ€è¦é…å›¾çš„é¢˜ç›®æ•°é‡ï¼‰
  â””â”€ è¾“å‡ºå®Œæ•´ JSONï¼ˆå«æ‰€æœ‰ç”Ÿæˆå†…å®¹å’Œå›¾åƒæ ‡è®°ï¼‰
```

### 3.3 Unit Test ç¼–è¯‘è§„åˆ™ï¼ˆPhase 3ï¼‰

#### 3.3.1 ç¼–è¯‘æµç¨‹

```typescript
/**
 * ä» Topic Quiz ç¼–è¯‘ Unit Test
 */
function compileUnitTest(unit: APUnit): UnitTest {
  // 1. æ”¶é›†æ‰€æœ‰ Topic Quiz ä¸­çš„é¢˜ç›®
  const allQuestions: QuizQuestion[] = [];
  for (const topic of unit.topics) {
    if (topic.quiz && topic.quiz.length > 0) {
      allQuestions.push(...topic.quiz);
    }
  }

  // 2. éšæœºé€‰æ‹© 15-20 é¢˜ï¼ˆæ ¹æ®é¢˜ç›®æ€»æ•°ï¼‰
  const targetCount = Math.min(20, Math.max(15, allQuestions.length));
  const selectedQuestions = shuffleAndSelect(allQuestions, targetCount);

  // 3. ä¿ç•™åŸé¢˜çš„æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ requires_imageï¼‰
  return {
    unit_number: unit.unit_number,
    test_title: `Unit ${unit.unit_number} Test`,
    questions: selectedQuestions, // å®Œæ•´ä¿ç•™ requires_image
    total_questions: selectedQuestions.length,
    estimated_minutes: selectedQuestions.length * 1.5 // æ¯é¢˜ 1.5 åˆ†é’Ÿ
  };
}
```

#### 3.3.2 é¢˜ç›®é€‰æ‹©ç­–ç•¥

- **æ•°é‡**ï¼š15-20 é¢˜ï¼ˆæ ¹æ® unit åŒ…å«çš„ topics æ•°é‡è°ƒæ•´ï¼‰
- **åˆ†å¸ƒ**ï¼šå°½é‡ä»ä¸åŒ topics ä¸­é€‰å–ï¼ˆä¿è¯è¦†ç›–é¢ï¼‰
- **éšæœºæ€§**ï¼šä½¿ç”¨åŠ æƒéšæœºï¼ˆä¼˜å…ˆé€‰æ‹©é‡è¦ topics çš„é¢˜ç›®ï¼‰
- **ä¿ç•™åŸå§‹æ•°æ®**ï¼š
  - `question`
  - `options`
  - `correct_answer`
  - `explanation`
  - **`requires_image`**ï¼ˆå…³é”®ï¼šå¿…é¡»ä¿ç•™ï¼‰

#### 3.3.3 ç¤ºä¾‹ Unit Test æ•°æ®

```json
{
  "unit_number": 1,
  "unit_title": "The Chemical Basis of Life",
  "unit_test": {
    "unit_number": 1,
    "test_title": "Unit 1 Test",
    "questions": [
      {
        "question": "Which property of water is most directly responsible for the transport of water from roots to leaves?",
        "options": [
          "A. Polarity",
          "B. Cohesion",
          "C. High specific heat",
          "D. Expansion upon freezing"
        ],
        "correct_answer": "B",
        "explanation": "Cohesion allows water molecules to stick together, creating a continuous column for transport.",
        "requires_image": false
      },
      {
        "question": "Based on the provided Lewis diagram, what is the molecular geometry of the species?",
        "options": [
          "A. Tetrahedral",
          "B. Linear",
          "C. Bent",
          "D. Trigonal planar"
        ],
        "correct_answer": "A",
        "explanation": "The molecule has four bonding regions and no lone pairs, resulting in tetrahedral geometry.",
        "requires_image": true
      }
    ],
    "total_questions": 18,
    "estimated_minutes": 27
  },
  "topics": [...]
}
```

### 3.4 æœ€ç»ˆéªŒè¯ä¸ç»Ÿè®¡ï¼ˆPhase 4ï¼‰

#### 3.4.1 æ•°æ®éªŒè¯æ¸…å•

åœ¨æœ€ç»ˆè¾“å‡ºå‰ï¼Œå¿…é¡»éªŒè¯ä»¥ä¸‹å†…å®¹ï¼š

1. **Flashcards éªŒè¯**
   ```typescript
   function validateFlashcards(course: APCourse): ValidationResult {
     for (const unit of course.units) {
       for (const topic of unit.topics) {
         if (topic.flashcards) {
           for (const card of topic.flashcards) {
             // æ£€æŸ¥ requires_image å­—æ®µæ˜¯å¦å­˜åœ¨
             if (card.requires_image === undefined) {
               return { valid: false, error: `Missing requires_image in flashcard: ${card.front}` };
             }
           }
         }
       }
     }
     return { valid: true };
   }
   ```

2. **Quiz Questions éªŒè¯**
   ```typescript
   function validateQuizQuestions(course: APCourse): ValidationResult {
     for (const unit of course.units) {
       // éªŒè¯ Topic Quiz
       for (const topic of unit.topics) {
         if (topic.quiz) {
           for (const q of topic.quiz) {
             if (q.requires_image === undefined) {
               return { valid: false, error: `Missing requires_image in topic quiz: ${q.question}` };
             }
           }
         }
       }
       
       // éªŒè¯ Unit Test
       if (unit.unit_test?.questions) {
         for (const q of unit.unit_test.questions) {
           if (q.requires_image === undefined) {
             return { valid: false, error: `Missing requires_image in unit test: ${q.question}` };
           }
         }
       }
     }
     return { valid: true };
   }
   ```

#### 3.4.2 å›¾åƒéœ€æ±‚ç»Ÿè®¡

```typescript
interface ImageStatistics {
  // Flashcards
  total_flashcards: number;
  flashcards_requiring_images: number;
  flashcards_image_percentage: number;
  
  // Topic Quiz
  total_topic_quiz_questions: number;
  topic_quiz_requiring_images: number;
  topic_quiz_image_percentage: number;
  
  // Unit Tests
  total_unit_test_questions: number;
  unit_test_requiring_images: number;
  unit_test_image_percentage: number;
  
  // æ€»è®¡
  total_items: number;
  total_requiring_images: number;
  overall_image_percentage: number;
}

function calculateImageStatistics(course: APCourse): ImageStatistics {
  let totalFlashcards = 0;
  let flashcardsRequiringImages = 0;
  let totalTopicQuiz = 0;
  let topicQuizRequiringImages = 0;
  let totalUnitTest = 0;
  let unitTestRequiringImages = 0;

  for (const unit of course.units) {
    for (const topic of unit.topics) {
      // ç»Ÿè®¡ Flashcards
      if (topic.flashcards) {
        totalFlashcards += topic.flashcards.length;
        flashcardsRequiringImages += topic.flashcards.filter(c => c.requires_image).length;
      }
      
      // ç»Ÿè®¡ Topic Quiz
      if (topic.quiz) {
        totalTopicQuiz += topic.quiz.length;
        topicQuizRequiringImages += topic.quiz.filter(q => q.requires_image).length;
      }
    }
    
    // ç»Ÿè®¡ Unit Test
    if (unit.unit_test?.questions) {
      totalUnitTest += unit.unit_test.questions.length;
      unitTestRequiringImages += unit.unit_test.questions.filter(q => q.requires_image).length;
    }
  }

  const totalItems = totalFlashcards + totalTopicQuiz + totalUnitTest;
  const totalRequiringImages = flashcardsRequiringImages + topicQuizRequiringImages + unitTestRequiringImages;

  return {
    total_flashcards: totalFlashcards,
    flashcards_requiring_images: flashcardsRequiringImages,
    flashcards_image_percentage: totalFlashcards > 0 ? (flashcardsRequiringImages / totalFlashcards) * 100 : 0,
    
    total_topic_quiz_questions: totalTopicQuiz,
    topic_quiz_requiring_images: topicQuizRequiringImages,
    topic_quiz_image_percentage: totalTopicQuiz > 0 ? (topicQuizRequiringImages / totalTopicQuiz) * 100 : 0,
    
    total_unit_test_questions: totalUnitTest,
    unit_test_requiring_images: unitTestRequiringImages,
    unit_test_image_percentage: totalUnitTest > 0 ? (unitTestRequiringImages / totalUnitTest) * 100 : 0,
    
    total_items: totalItems,
    total_requiring_images: totalRequiringImages,
    overall_image_percentage: totalItems > 0 ? (totalRequiringImages / totalItems) * 100 : 0
  };
}
```

#### 3.4.3 æœ€ç»ˆè¾“å‡ºç»“æ„

```json
{
  "course_name": "AP Biology",
  "units": [...],
  "metadata": {
    "extracted_at": "2025-10-07T15:15:52Z",
    "pdf_file_name": "ap-biology-ced.pdf",
    "pdf_page_count": 200,
    "version": "2024"
  },
  "image_statistics": {
    "total_flashcards": 300,
    "flashcards_requiring_images": 45,
    "flashcards_image_percentage": 15,
    "total_topic_quiz_questions": 500,
    "topic_quiz_requiring_images": 80,
    "topic_quiz_image_percentage": 16,
    "total_unit_test_questions": 160,
    "unit_test_requiring_images": 28,
    "unit_test_image_percentage": 17.5,
    "total_items": 960,
    "total_requiring_images": 153,
    "overall_image_percentage": 15.9
  }
}
```

## 4. æ•°æ®å¤„ç†æµç¨‹ï¼ˆ4æ­¥éª¤ï¼‰

### 4.1 å¤„ç†æµç¨‹æ¦‚è¿°

```
æ­¥éª¤1: è¯»å–è¾“å…¥æ•°æ®
  â”œâ”€ PDF æ–‡ä»¶ï¼ˆç”¨äºå±•ç¤ºå¯¹ç…§ï¼‰
  â””â”€ JSON æ–‡ä»¶ï¼ˆåŸå§‹è¯¾ç¨‹ç»“æ„æ•°æ®ï¼‰

æ­¥éª¤2: ç»Ÿè®¡è®¡ç®—
  â”œâ”€ è¯¾ç¨‹çº§åˆ«ç»Ÿè®¡
  â”œâ”€ å•å…ƒçº§åˆ«ç»Ÿè®¡
  â””â”€ ä¸»é¢˜çº§åˆ«ç»Ÿè®¡

æ­¥éª¤3: æ•°æ®åˆå¹¶
  â””â”€ åŸå§‹æ•°æ® + è®¡ç®—æ•°æ®

æ­¥éª¤4: è¾“å‡ºç»“æœ
  â””â”€ å®Œæ•´ JSONï¼ˆåŒ…å«åŸºç¡€æ•°æ®å’Œè®¡ç®—æ•°æ®ï¼‰
```

### 3.2 API è·¯ç”±è§„åˆ’

#### POST /api/process
å¤„ç†è¯¾ç¨‹æ•°æ®ï¼ˆæ ¸å¿ƒAPIï¼‰

**è¯·æ±‚**ï¼š
```typescript
// Content-Type: multipart/form-data
{
  pdfFile: File;      // PDFæ–‡ä»¶ï¼ˆç”¨äºå¯¹ç…§å±•ç¤ºï¼‰
  jsonFile: File;     // JSONæ–‡ä»¶ï¼ˆåŸå§‹è¯¾ç¨‹æ•°æ®ï¼‰
}
```

**å“åº”**ï¼š
```typescript
{
  success: boolean;
  data?: EnrichedAPCourse;  // å®Œæ•´æ•°æ®ï¼ˆåŸå§‹+è®¡ç®—ï¼‰
  error?: string;
  warnings?: string[];
  processingTime: number;
}
```

### 3.3 è®¡ç®—æ•°æ®ç»“æ„å®šä¹‰

```typescript
// src/types/enriched-course.ts

/**
 * å¢å¼ºçš„è¯¾ç¨‹æ•°æ®ï¼ˆåŸå§‹æ•°æ® + è®¡ç®—æ•°æ®ï¼‰
 */
export interface EnrichedAPCourse extends APCourse {
  // æ·»åŠ è®¡ç®—çš„ç»Ÿè®¡æ•°æ®
  statistics: CourseStatistics;
}

/**
 * è¯¾ç¨‹ç»Ÿè®¡æ•°æ®
 */
export interface CourseStatistics {
  // è¯¾ç¨‹çº§åˆ«ç»Ÿè®¡
  total_units: number;
  total_topics: number;
  total_learning_objectives: number;
  total_essential_knowledge: number;
  
  // å•å…ƒç»Ÿè®¡è¯¦æƒ…
  unit_statistics: UnitStatistics[];
  
  // çŸ¥è¯†ç‚¹å±‚çº§åˆ†å¸ƒ
  knowledge_hierarchy: KnowledgeHierarchy;
  
  // è€ƒè¯•æƒé‡åˆ†æ
  exam_weight_distribution: ExamWeightDistribution[];
}

/**
 * å•å…ƒç»Ÿè®¡
 */
export interface UnitStatistics {
  unit_number: number;
  unit_title: string;
  topic_count: number;
  learning_objective_count: number;
  essential_knowledge_count: number;
  class_periods: number; // ä» "~8 Class Periods" æå–æ•°å­—
  exam_weight_min: number; // ä» "4-6%" æå–æœ€å°å€¼
  exam_weight_max: number; // ä» "4-6%" æå–æœ€å¤§å€¼
  exam_weight_avg: number; // å¹³å‡å€¼
}

/**
 * çŸ¥è¯†ç‚¹å±‚çº§åˆ†å¸ƒ
 */
export interface KnowledgeHierarchy {
  // æŒ‰å±‚çº§ç»Ÿè®¡ KC æ•°é‡
  level_1: number; // å¦‚ KC-1.1
  level_2: number; // å¦‚ KC-1.1.I
  level_3: number; // å¦‚ KC-1.1.I.A
  level_4: number; // å¦‚ KC-1.1.I.A.i
  
  // è¯¦ç»†åˆ—è¡¨
  by_level: {
    level: number;
    count: number;
    examples: string[]; // ç¤ºä¾‹ID
  }[];
}

/**
 * è€ƒè¯•æƒé‡åˆ†å¸ƒ
 */
export interface ExamWeightDistribution {
  unit_number: number;
  weight_range: string; // å¦‚ "4-6%"
  min_weight: number;
  max_weight: number;
  avg_weight: number;
  class_periods: number;
  efficiency: number; // æƒé‡/è¯¾æ—¶æ¯”
}
```

### 3.4 API å®ç°ç¤ºä¾‹

```typescript
// src/app/api/process/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { processAPCourseData } from '@/lib/data-processor';
import { APCourseSchema } from '@/lib/validators';

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();
    const pdfFile = formData.get('pdfFile') as File;
    const jsonFile = formData.get('jsonFile') as File;
    
    // éªŒè¯æ–‡ä»¶
    if (!pdfFile || !jsonFile) {
      return NextResponse.json(
        { success: false, error: 'PDFå’ŒJSONæ–‡ä»¶éƒ½æ˜¯å¿…éœ€çš„' },
        { status: 400 }
      );
    }

    if (!pdfFile.name.endsWith('.pdf')) {
      return NextResponse.json(
        { success: false, error: 'PDFæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®' },
        { status: 400 }
      );
    }

    if (!jsonFile.name.endsWith('.json')) {
      return NextResponse.json(
        { success: false, error: 'JSONæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®' },
        { status: 400 }
      );
    }

    // è¯»å–JSONå†…å®¹
    const jsonText = await jsonFile.text();
    const courseData = JSON.parse(jsonText);
    
    // éªŒè¯JSONæ•°æ®ç»“æ„
    const validation = APCourseSchema.safeParse(courseData);
    if (!validation.success) {
      return NextResponse.json({
        success: false,
        error: 'JSONæ•°æ®ç»“æ„éªŒè¯å¤±è´¥',
        warnings: validation.error.issues.map(i => i.message),
      }, { status: 400 });
    }

    // å¤„ç†æ•°æ®ï¼ˆæ­¥éª¤2-3ï¼šè®¡ç®—+åˆå¹¶ï¼‰
    const startTime = Date.now();
    const enrichedData = await processAPCourseData(courseData);
    const processingTime = Date.now() - startTime;

    // ä¿å­˜PDFæ–‡ä»¶ç”¨äºåç»­å±•ç¤º
    const pdfBytes = await pdfFile.arrayBuffer();
    const pdfBuffer = Buffer.from(pdfBytes);
    // è¿™é‡Œå¯ä»¥ä¿å­˜åˆ°ä¸´æ—¶ç›®å½•æˆ–è¿”å›base64

    return NextResponse.json({
      success: true,
      data: enrichedData,
      processingTime,
      warnings: [],
    });
  } catch (error) {
    console.error('å¤„ç†é”™è¯¯:', error);
    return NextResponse.json(
      { 
        success: false, 
        error: error instanceof Error ? error.message : 'æ•°æ®å¤„ç†å¤±è´¥' 
      },
      { status: 500 }
    );
  }
}
```

## 4. ç»„ä»¶è®¾è®¡

### 4.1 ç»„ä»¶æ ‘ç»“æ„

```
App
â”œâ”€â”€ Layout
â”‚   â”œâ”€â”€ Header
â”‚   â””â”€â”€ Footer
â”œâ”€â”€ HomePage (/)
â”‚   â”œâ”€â”€ UploadSection
â”‚   â”‚   â”œâ”€â”€ FileDropZone
â”‚   â”‚   â””â”€â”€ UploadProgress
â”‚   â””â”€â”€ RecentFiles
â””â”€â”€ ProcessorPage (/processor)
    â”œâ”€â”€ Sidebar
    â”‚   â”œâ”€â”€ FileInfo
    â”‚   â””â”€â”€ ExportButtons
    â”œâ”€â”€ MainContent
    â”‚   â”œâ”€â”€ TabNavigation
    â”‚   â”œâ”€â”€ PreviewTab
    â”‚   â”‚   â””â”€â”€ JSONViewer
    â”‚   â”œâ”€â”€ CompareTab
    â”‚   â”‚   â”œâ”€â”€ PDFViewer (å·¦)
    â”‚   â”‚   â””â”€â”€ JSONTree (å³)
    â”‚   â””â”€â”€ EditTab
    â”‚       â””â”€â”€ MonacoEditor
    â””â”€â”€ StatusBar
```

### 4.2 æ ¸å¿ƒç»„ä»¶è§„æ ¼

#### DualFileUpload ç»„ä»¶

```typescript
// src/components/DualFileUpload.tsx
'use client';

import { useState } from 'react';
import { Upload, FileText, CheckCircle } from 'lucide-react';

interface DualFileUploadProps {
  onFilesSelect: (pdfFile: File, jsonFile: File) => void;
  maxSize?: number; // å­—èŠ‚
  disabled?: boolean;
}

export function DualFileUpload({ 
  onFilesSelect, 
  maxSize = 50 * 1024 * 1024,
  disabled = false 
}: DualFileUploadProps) {
  const [pdfFile, setPdfFile] = useState<File | null>(null);
  const [jsonFile, setJsonFile] = useState<File | null>(null);
  const [error, setError] = useState<string>('');

  const handlePdfChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setError('');
    const file = e.target.files?.[0];
    
    if (!file) return;
    
    if (!file.name.endsWith('.pdf')) {
      setError('è¯·é€‰æ‹© PDF æ ¼å¼æ–‡ä»¶');
      return;
    }
    
    if (file.size > maxSize) {
      setError(`PDF æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ ${maxSize / 1024 / 1024}MB`);
      return;
    }
    
    setPdfFile(file);
    
    // å¦‚æœä¸¤ä¸ªæ–‡ä»¶éƒ½å·²é€‰æ‹©ï¼Œè§¦å‘å›è°ƒ
    if (jsonFile) {
      onFilesSelect(file, jsonFile);
    }
  };

  const handleJsonChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setError('');
    const file = e.target.files?.[0];
    
    if (!file) return;
    
    if (!file.name.endsWith('.json')) {
      setError('è¯·é€‰æ‹© JSON æ ¼å¼æ–‡ä»¶');
      return;
    }
    
    if (file.size > maxSize) {
      setError(`JSON æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ ${maxSize / 1024 / 1024}MB`);
      return;
    }
    
    setJsonFile(file);
    
    // å¦‚æœä¸¤ä¸ªæ–‡ä»¶éƒ½å·²é€‰æ‹©ï¼Œè§¦å‘å›è°ƒ
    if (pdfFile) {
      onFilesSelect(pdfFile, file);
    }
  };

  return (
    <div className="space-y-4">
      {/* PDF æ–‡ä»¶ä¸Šä¼  */}
      <div className={`
        border-2 border-dashed rounded-lg p-8
        transition-colors
        ${pdfFile ? 'border-green-500 bg-green-50' : 'border-gray-300'}
        ${disabled ? 'opacity-50 cursor-not-allowed' : ''}
      `}>
        <div className="flex flex-col items-center gap-4">
          {pdfFile ? (
            <CheckCircle className="w-12 h-12 text-green-500" />
          ) : (
            <FileText className="w-12 h-12 text-gray-400" />
          )}
          <div className="text-center">
            <p className="text-lg font-medium">
              {pdfFile ? `å·²é€‰æ‹©: ${pdfFile.name}` : 'AP è¯¾ç¨‹ PDF æ–‡ä»¶'}
            </p>
            <p className="text-sm text-gray-500 mt-1">
              ç”¨äºå¯¹ç…§å±•ç¤ºï¼ˆå¿…éœ€ï¼‰
            </p>
          </div>
          <label className="btn-primary cursor-pointer">
            <input
              type="file"
              accept=".pdf"
              onChange={handlePdfChange}
              disabled={disabled}
              className="hidden"
            />
            {pdfFile ? 'é‡æ–°é€‰æ‹©' : 'é€‰æ‹© PDF'}
          </label>
        </div>
      </div>

      {/* JSON æ–‡ä»¶ä¸Šä¼  */}
      <div className={`
        border-2 border-dashed rounded-lg p-8
        transition-colors
        ${jsonFile ? 'border-green-500 bg-green-50' : 'border-gray-300'}
        ${disabled ? 'opacity-50 cursor-not-allowed' : ''}
      `}>
        <div className="flex flex-col items-center gap-4">
          {jsonFile ? (
            <CheckCircle className="w-12 h-12 text-green-500" />
          ) : (
            <FileText className="w-12 h-12 text-gray-400" />
          )}
          <div className="text-center">
            <p className="text-lg font-medium">
              {jsonFile ? `å·²é€‰æ‹©: ${jsonFile.name}` : 'è¯¾ç¨‹åŸå§‹æ•°æ® JSON'}
            </p>
            <p className="text-sm text-gray-500 mt-1">
              å·²æå–çš„è¯¾ç¨‹ç»“æ„æ•°æ®ï¼ˆå¿…éœ€ï¼‰
            </p>
          </div>
          <label className="btn-primary cursor-pointer">
            <input
              type="file"
              accept=".json"
              onChange={handleJsonChange}
              disabled={disabled}
              className="hidden"
            />
            {jsonFile ? 'é‡æ–°é€‰æ‹©' : 'é€‰æ‹© JSON'}
          </label>
        </div>
      </div>

      {/* é”™è¯¯æç¤º */}
      {error && (
        <p className="text-sm text-red-500 text-center">{error}</p>
      )}

      {/* æç¤ºä¿¡æ¯ */}
      {pdfFile && jsonFile && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p className="text-sm text-blue-800 text-center">
            âœ“ ä¸¤ä¸ªæ–‡ä»¶éƒ½å·²å‡†å¤‡å¥½ï¼Œå¼€å§‹å¤„ç†...
          </p>
        </div>
      )}
    </div>
  );
}
```

#### JSONViewer ç»„ä»¶

```typescript
// src/components/JSONViewer.tsx
'use client';

import { useState } from 'react';
import { ChevronRight, ChevronDown, Copy } from 'lucide-react';
import type { APCourse } from '@/types/course';

interface JSONViewerProps {
  data: APCourse;
  onNodeClick?: (path: string) => void;
}

export function JSONViewer({ data, onNodeClick }: JSONViewerProps) {
  const [expandedPaths, setExpandedPaths] = useState<Set<string>>(
    new Set(['root'])
  );

  const toggleExpand = (path: string) => {
    const newExpanded = new Set(expandedPaths);
    if (newExpanded.has(path)) {
      newExpanded.delete(path);
    } else {
      newExpanded.add(path);
    }
    setExpandedPaths(newExpanded);
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(JSON.stringify(data, null, 2));
  };

  return (
    <div className="bg-gray-50 rounded-lg p-4 font-mono text-sm">
      <div className="flex justify-between items-center mb-4">
        <h3 className="font-semibold">JSON æ•°æ®</h3>
        <button
          onClick={copyToClipboard}
          className="flex items-center gap-2 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
        >
          <Copy className="w-4 h-4" />
          å¤åˆ¶
        </button>
      </div>
      
      <TreeNode
        data={data}
        path="root"
        expandedPaths={expandedPaths}
        onToggle={toggleExpand}
        onNodeClick={onNodeClick}
      />
    </div>
  );
}

// TreeNode é€’å½’ç»„ä»¶å®ç°...
```

#### PDFViewer ç»„ä»¶

```typescript
// src/components/PDFViewer.tsx
'use client';

import { useState } from 'react';
import { Document, Page, pdfjs } from 'react-pdf';
import { ChevronLeft, ChevronRight, ZoomIn, ZoomOut } from 'lucide-react';

// PDF.js worker é…ç½®
pdfjs.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.mjs`;

interface PDFViewerProps {
  fileUrl: string;
  initialPage?: number;
  onPageChange?: (page: number) => void;
}

export function PDFViewer({ 
  fileUrl, 
  initialPage = 1,
  onPageChange 
}: PDFViewerProps) {
  const [numPages, setNumPages] = useState<number>(0);
  const [pageNumber, setPageNumber] = useState(initialPage);
  const [scale, setScale] = useState(1.0);

  function onDocumentLoadSuccess({ numPages }: { numPages: number }) {
    setNumPages(numPages);
  }

  function changePage(offset: number) {
    const newPage = pageNumber + offset;
    if (newPage >= 1 && newPage <= numPages) {
      setPageNumber(newPage);
      onPageChange?.(newPage);
    }
  }

  const changeZoom = (delta: number) => {
    const newScale = Math.max(0.5, Math.min(2.0, scale + delta));
    setScale(newScale);
  };

  return (
    <div className="flex flex-col h-full">
      {/* æ§åˆ¶æ  */}
      <div className="flex items-center justify-between p-4 bg-gray-100 border-b">
        <div className="flex items-center gap-2">
          <button
            onClick={() => changePage(-1)}
            disabled={pageNumber <= 1}
            className="p-2 rounded hover:bg-gray-200 disabled:opacity-50"
          >
            <ChevronLeft className="w-5 h-5" />
          </button>
          
          <span className="text-sm">
            ç¬¬ {pageNumber} é¡µ / å…± {numPages} é¡µ
          </span>
          
          <button
            onClick={() => changePage(1)}
            disabled={pageNumber >= numPages}
            className="p-2 rounded hover:bg-gray-200 disabled:opacity-50"
          >
            <ChevronRight className="w-5 h-5" />
          </button>
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={() => changeZoom(-0.1)}
            className="p-2 rounded hover:bg-gray-200"
          >
            <ZoomOut className="w-5 h-5" />
          </button>
          
          <span className="text-sm">{Math.round(scale * 100)}%</span>
          
          <button
            onClick={() => changeZoom(0.1)}
            className="p-2 rounded hover:bg-gray-200"
          >
            <ZoomIn className="w-5 h-5" />
          </button>
        </div>
      </div>

      {/* PDF æ˜¾ç¤ºåŒºåŸŸ */}
      <div className="flex-1 overflow-auto bg-gray-200 p-4">
        <Document
          file={fileUrl}
          onLoadSuccess={onDocumentLoadSuccess}
          className="flex justify-center"
        >
          <Page 
            pageNumber={pageNumber} 
            scale={scale}
            renderTextLayer={true}
            renderAnnotationLayer={true}
          />
        </Document>
      </div>
    </div>
  );
}
```

## 5. çŠ¶æ€ç®¡ç†

### 5.1 Zustand Store è®¾è®¡

```typescript
// src/store/useAppStore.ts
import { create } from 'zustand';
import type { APCourse, UploadState } from '@/types/course';

interface AppState {
  // ä¸Šä¼ çŠ¶æ€
  uploadState: UploadState;
  setUploadState: (state: Partial<UploadState>) => void;
  
  // æ–‡ä»¶ä¿¡æ¯
  fileId: string | null;
  fileName: string | null;
  setFileInfo: (id: string, name: string) => void;
  
  // è¯¾ç¨‹æ•°æ®
  courseData: APCourse | null;
  setCourseData: (data: APCourse | null) => void;
  
  // UI çŠ¶æ€
  activeTab: 'preview' | 'compare' | 'edit';
  setActiveTab: (tab: 'preview' | 'compare' | 'edit') => void;
  
  currentPage: number;
  setCurrentPage: (page: number) => void;
  
  // æ“ä½œæ–¹æ³•
  reset: () => void;
}

export const useAppStore = create<AppState>((set) => ({
  // åˆå§‹çŠ¶æ€
  uploadState: {
    status: 'idle',
    progress: 0,
  },
  fileId: null,
  fileName: null,
  courseData: null,
  activeTab: 'preview',
  currentPage: 1,
  
  // è®¾ç½®æ–¹æ³•
  setUploadState: (state) =>
    set((prev) => ({
      uploadState: { ...prev.uploadState, ...state },
    })),
    
  setFileInfo: (id, name) =>
    set({ fileId: id, fileName: name }),
    
  setCourseData: (data) =>
    set({ courseData: data }),
    
  setActiveTab: (tab) =>
    set({ activeTab: tab }),
    
  setCurrentPage: (page) =>
    set({ currentPage: page }),
    
  reset: () =>
    set({
      uploadState: { status: 'idle', progress: 0 },
      fileId: null,
      fileName: null,
      courseData: null,
      activeTab: 'preview',
      currentPage: 1,
    }),
}));

// ä½¿ç”¨ç¤ºä¾‹
// const { courseData, setCourseData } = useAppStore();
// courseData.course_name, courseData.units[0].unit_title
```

## 6. æ•°æ®å¤„ç†æœåŠ¡ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰

### 6.1 æ•°æ®å¤„ç†ä¸»æµç¨‹

```typescript
// src/lib/data-processor.ts
import type { APCourse, EnrichedAPCourse, CourseStatistics } from '@/types/course';

/**
 * å¤„ç† AP è¯¾ç¨‹æ•°æ®ï¼ˆæ­¥éª¤ 2-3-4ï¼‰
 * æ­¥éª¤2: ç»Ÿè®¡è®¡ç®—
 * æ­¥éª¤3: æ•°æ®åˆå¹¶
 * æ­¥éª¤4: è¿”å›å®Œæ•´æ•°æ®
 */
export async function processAPCourseData(
  courseData: APCourse
): Promise<EnrichedAPCourse> {
  // æ­¥éª¤2: è®¡ç®—ç»Ÿè®¡æ•°æ®
  const statistics = calculateStatistics(courseData);
  
  // æ­¥éª¤3: åˆå¹¶æ•°æ®
  const enrichedData: EnrichedAPCourse = {
    ...courseData,
    statistics,
  };
  
  // æ­¥éª¤4: è¿”å›å®Œæ•´æ•°æ®
  return enrichedData;
}

/**
 * æ­¥éª¤2: è®¡ç®—è¯¾ç¨‹ç»Ÿè®¡æ•°æ®
 */
function calculateStatistics(courseData: APCourse): CourseStatistics {
  // è¯¾ç¨‹çº§åˆ«ç»Ÿè®¡
  const total_units = courseData.units.length;
  const total_topics = courseData.units.reduce(
    (sum, unit) => sum + unit.topics.length, 
    0
  );
  const total_learning_objectives = courseData.units.reduce(
    (sum, unit) => sum + unit.topics.reduce(
      (topicSum, topic) => topicSum + topic.learning_objectives.length,
      0
    ),
    0
  );
  const total_essential_knowledge = courseData.units.reduce(
    (sum, unit) => sum + unit.topics.reduce(
      (topicSum, topic) => topicSum + topic.essential_knowledge.length,
      0
    ),
    0
  );

  // å•å…ƒç»Ÿè®¡è¯¦æƒ…
  const unit_statistics = courseData.units.map(unit => 
    calculateUnitStatistics(unit)
  );

  // çŸ¥è¯†ç‚¹å±‚çº§åˆ†å¸ƒ
  const knowledge_hierarchy = calculateKnowledgeHierarchy(courseData);

  // è€ƒè¯•æƒé‡åˆ†æ
  const exam_weight_distribution = courseData.units.map(unit => 
    calculateExamWeight(unit)
  );

  return {
    total_units,
    total_topics,
    total_learning_objectives,
    total_essential_knowledge,
    unit_statistics,
    knowledge_hierarchy,
    exam_weight_distribution,
  };
}

/**
 * è®¡ç®—å•ä¸ªå•å…ƒçš„ç»Ÿè®¡æ•°æ®
 */
function calculateUnitStatistics(unit: APUnit): UnitStatistics {
  const topic_count = unit.topics.length;
  
  const learning_objective_count = unit.topics.reduce(
    (sum, topic) => sum + topic.learning_objectives.length,
    0
  );
  
  const essential_knowledge_count = unit.topics.reduce(
    (sum, topic) => sum + topic.essential_knowledge.length,
    0
  );

  // ä» "~8 Class Periods" æå–æ•°å­—
  const class_periods = extractClassPeriods(unit.ced_class_periods);

  // ä» "4-6%" æå–æƒé‡èŒƒå›´
  const { min, max, avg } = extractExamWeight(unit.exam_weight);

  return {
    unit_number: unit.unit_number,
    unit_title: unit.unit_title,
    topic_count,
    learning_objective_count,
    essential_knowledge_count,
    class_periods,
    exam_weight_min: min,
    exam_weight_max: max,
    exam_weight_avg: avg,
  };
}

/**
 * è®¡ç®—çŸ¥è¯†ç‚¹å±‚çº§åˆ†å¸ƒ
 */
function calculateKnowledgeHierarchy(
  courseData: APCourse
): KnowledgeHierarchy {
  const levelCounts = {
    level_1: 0,
    level_2: 0,
    level_3: 0,
    level_4: 0,
  };
  
  const levelExamples: Record<number, string[]> = {
    1: [],
    2: [],
    3: [],
    4: [],
  };

  // éå†æ‰€æœ‰ essential_knowledge
  courseData.units.forEach(unit => {
    unit.topics.forEach(topic => {
      topic.essential_knowledge.forEach(ek => {
        const level = getKnowledgeLevel(ek.id);
        
        if (level === 1) levelCounts.level_1++;
        else if (level === 2) levelCounts.level_2++;
        else if (level === 3) levelCounts.level_3++;
        else if (level === 4) levelCounts.level_4++;

        // æ”¶é›†ç¤ºä¾‹ï¼ˆæœ€å¤š3ä¸ªï¼‰
        if (levelExamples[level].length < 3) {
          levelExamples[level].push(ek.id);
        }
      });
    });
  });

  return {
    ...levelCounts,
    by_level: [
      { level: 1, count: levelCounts.level_1, examples: levelExamples[1] },
      { level: 2, count: levelCounts.level_2, examples: levelExamples[2] },
      { level: 3, count: levelCounts.level_3, examples: levelExamples[3] },
      { level: 4, count: levelCounts.level_4, examples: levelExamples[4] },
    ],
  };
}

/**
 * è®¡ç®—è€ƒè¯•æƒé‡åˆ†å¸ƒ
 */
function calculateExamWeight(unit: APUnit): ExamWeightDistribution {
  const class_periods = extractClassPeriods(unit.ced_class_periods);
  const { min, max, avg } = extractExamWeight(unit.exam_weight);
  
  // è®¡ç®—æ•ˆç‡ï¼šæƒé‡/è¯¾æ—¶æ¯”
  const efficiency = class_periods > 0 ? avg / class_periods : 0;

  return {
    unit_number: unit.unit_number,
    weight_range: unit.exam_weight,
    min_weight: min,
    max_weight: max,
    avg_weight: avg,
    class_periods,
    efficiency: Number(efficiency.toFixed(4)),
  };
}

// ========== è¾…åŠ©å‡½æ•° ==========

/**
 * ä» "~8 Class Periods" æå–æ•°å­—
 */
function extractClassPeriods(text: string): number {
  const match = text.match(/(\d+)/);
  return match ? parseInt(match[1], 10) : 0;
}

/**
 * ä» "4-6%" æå–æƒé‡
 */
function extractExamWeight(text: string): { min: number; max: number; avg: number } {
  const match = text.match(/(\d+)-(\d+)%/);
  if (!match) {
    return { min: 0, max: 0, avg: 0 };
  }
  
  const min = parseInt(match[1], 10);
  const max = parseInt(match[2], 10);
  const avg = (min + max) / 2;
  
  return { min, max, avg };
}

/**
 * åˆ¤æ–­ KC çš„å±‚çº§
 * KC-1.1 -> 1
 * KC-1.1.I -> 2
 * KC-1.1.I.A -> 3
 * KC-1.1.I.A.i -> 4
 */
function getKnowledgeLevel(kcId: string): number {
  // ç§»é™¤ "KC-" å‰ç¼€
  const parts = kcId.replace(/^KC-/, '').split('.');
  
  // è®¡ç®—å±‚çº§
  let level = 1; // åŸºç¡€å±‚çº§ (å¦‚ KC-1.1)
  
  for (let i = 0; i < parts.length; i++) {
    const part = parts[i];
    
    // æ£€æŸ¥æ˜¯å¦åŒ…å«ç½—é©¬æ•°å­— (I, II, III, IV)
    if (/^[IVX]+$/i.test(part)) {
      level++;
    }
    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¤§å†™å­—æ¯ (A, B, C)
    else if (/^[A-Z]$/.test(part)) {
      level++;
    }
    // æ£€æŸ¥æ˜¯å¦åŒ…å«å°å†™å­—æ¯æˆ–æ•°å­—åŠ å°å†™å­—æ¯ (i, ii, a, b)
    else if (/^[a-z]+$/i.test(part) && part.length <= 2) {
      level++;
    }
  }
  
  return Math.min(level, 4); // æœ€å¤š4å±‚
}
```

### 6.2 ç±»å‹å¯¼å…¥

```typescript
// src/types/course.ts ä¸­éœ€è¦å¯¼å…¥çš„ç±»å‹
import type {
  UnitStatistics,
  KnowledgeHierarchy,
  ExamWeightDistribution,
} from './enriched-course';
```

## 7. è·¯ç”±è®¾è®¡

### 7.1 App Router ç»“æ„

```
src/app/
â”œâ”€â”€ layout.tsx              # æ ¹å¸ƒå±€
â”œâ”€â”€ page.tsx                # é¦–é¡µï¼ˆåŒæ–‡ä»¶ä¸Šä¼ ï¼‰
â”œâ”€â”€ processor/
â”‚   â”œâ”€â”€ page.tsx            # å¤„ç†é¡µé¢
â”‚   â””â”€â”€ loading.tsx         # åŠ è½½çŠ¶æ€
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ process/
â”‚   â”‚   â””â”€â”€ route.ts        # æ•°æ®å¤„ç† APIï¼ˆæ ¸å¿ƒï¼‰
â”‚   â””â”€â”€ export/
â”‚       â””â”€â”€ route.ts        # å¯¼å‡º JSON API
â””â”€â”€ globals.css             # å…¨å±€æ ·å¼
```

### 7.2 é¡µé¢å®ç°

```typescript
// src/app/page.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { DualFileUpload } from '@/components/DualFileUpload';
import { Header } from '@/components/Header';
import { useAppStore } from '@/store/useAppStore';

export default function HomePage() {
  const router = useRouter();
  const { setUploadState, setCourseData } = useAppStore();
  const [isProcessing, setIsProcessing] = useState(false);

  const handleFilesSelect = async (pdfFile: File, jsonFile: File) => {
    setIsProcessing(true);
    setUploadState({ status: 'uploading', progress: 0 });

    try {
      const formData = new FormData();
      formData.append('pdfFile', pdfFile);
      formData.append('jsonFile', jsonFile);

      setUploadState({ status: 'processing', progress: 50 });

      const response = await fetch('/api/process', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (result.success) {
        setCourseData(result.data);
        setUploadState({ 
          status: 'success', 
          progress: 100,
          message: `å¤„ç†å®Œæˆï¼ˆç”¨æ—¶ ${result.processingTime}msï¼‰`
        });
        
        // è·³è½¬åˆ°å¤„ç†é¡µé¢
        router.push('/processor');
      } else {
        throw new Error(result.error || 'å¤„ç†å¤±è´¥');
      }
    } catch (error) {
      console.error('å¤„ç†é”™è¯¯:', error);
      setUploadState({
        status: 'error',
        progress: 0,
        error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯',
      });
    } finally {
      setIsProcessing(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-gray-50">
      <Header />
      <main className="flex-1 container mx-auto px-4 py-12">
        <div className="max-w-4xl mx-auto">
          <div className="text-center mb-12">
            <h1 className="text-4xl font-bold mb-4">
              PrepGo AP è¯¾ç¨‹å¤„ç†å·¥å…·
            </h1>
            <p className="text-gray-600 text-lg">
              ä¸Šä¼  PDF å’Œ JSON æ–‡ä»¶ï¼Œè‡ªåŠ¨è®¡ç®—ç»Ÿè®¡æ•°æ®å¹¶ç”Ÿæˆå®Œæ•´çš„è¯¾ç¨‹ç»“æ„
            </p>
          </div>

          <div className="bg-white rounded-2xl shadow-lg p-8">
            <DualFileUpload 
              onFilesSelect={handleFilesSelect}
              disabled={isProcessing}
            />

            {isProcessing && (
              <div className="mt-8">
                <div className="flex flex-col items-center gap-4">
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className="bg-blue-500 h-2 rounded-full transition-all duration-300"
                      style={{ width: `${50}%` }}
                    />
                  </div>
                  <p className="text-sm text-gray-600">
                    æ­£åœ¨å¤„ç†è¯¾ç¨‹æ•°æ®...
                  </p>
                </div>
              </div>
            )}
          </div>

          {/* åŠŸèƒ½è¯´æ˜ */}
          <div className="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="bg-white rounded-lg p-6 shadow">
              <div className="text-2xl mb-3">ğŸ“Š</div>
              <h3 className="font-semibold mb-2">ç»Ÿè®¡è®¡ç®—</h3>
              <p className="text-sm text-gray-600">
                è‡ªåŠ¨è®¡ç®—å•å…ƒã€ä¸»é¢˜ã€å­¦ä¹ ç›®æ ‡å’ŒçŸ¥è¯†ç‚¹çš„æ•°é‡ç»Ÿè®¡
              </p>
            </div>
            <div className="bg-white rounded-lg p-6 shadow">
              <div className="text-2xl mb-3">ğŸ”</div>
              <h3 className="font-semibold mb-2">å±‚çº§åˆ†æ</h3>
              <p className="text-sm text-gray-600">
                åˆ†æçŸ¥è¯†ç‚¹çš„å±‚çº§åˆ†å¸ƒï¼Œæä¾›è¯¦ç»†çš„ç»“æ„æ´å¯Ÿ
              </p>
            </div>
            <div className="bg-white rounded-lg p-6 shadow">
              <div className="text-2xl mb-3">âš–ï¸</div>
              <h3 className="font-semibold mb-2">æƒé‡åˆ†æ</h3>
              <p className="text-sm text-gray-600">
                è®¡ç®—è€ƒè¯•æƒé‡åˆ†å¸ƒå’Œå­¦ä¹ æ•ˆç‡æŒ‡æ ‡
              </p>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
}
```

## 8. æ ·å¼è§„èŒƒ

### 8.1 Tailwind é…ç½®

```typescript
// tailwind.config.ts
import type { Config } from 'tailwindcss';

const config: Config = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#eff6ff',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8',
        },
      },
      fontFamily: {
        sans: ['var(--font-geist-sans)'],
        mono: ['var(--font-geist-mono)'],
      },
    },
  },
  plugins: [
    require('@tailwindcss/typography'),
  ],
};

export default config;
```

### 8.2 è®¾è®¡ä»¤ç‰Œ

```css
/* src/app/globals.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --radius: 0.5rem;
  }
}

@layer components {
  .btn-primary {
    @apply bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors;
  }
  
  .card {
    @apply bg-white rounded-lg shadow-md p-6;
  }
}
```

## 9. é”™è¯¯å¤„ç†

### 9.1 é”™è¯¯è¾¹ç•Œ

```typescript
// src/components/ErrorBoundary.tsx
'use client';

import { Component, ReactNode } from 'react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: any) {
    console.error('é”™è¯¯è¾¹ç•Œæ•è·:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="flex items-center justify-center min-h-screen">
          <div className="text-center">
            <h2 className="text-2xl font-bold text-red-600 mb-4">
              å‡ºé”™äº†
            </h2>
            <p className="text-gray-600">
              {this.state.error?.message || 'æœªçŸ¥é”™è¯¯'}
            </p>
            <button
              onClick={() => window.location.reload()}
              className="mt-4 btn-primary"
            >
              åˆ·æ–°é¡µé¢
            </button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}
```

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 ä¼˜åŒ–ç­–ç•¥

1. **ä»£ç åˆ†å‰²**
   - ä½¿ç”¨ `dynamic` åŠ¨æ€å¯¼å…¥å¤§å‹ç»„ä»¶
   - PDF æŸ¥çœ‹å™¨æŒ‰éœ€åŠ è½½

2. **å›¾ç‰‡ä¼˜åŒ–**
   - ä½¿ç”¨ Next.js `Image` ç»„ä»¶
   - è‡ªåŠ¨ä¼˜åŒ–æ ¼å¼å’Œå¤§å°

3. **ç¼“å­˜ç­–ç•¥**
   - API å“åº”ç¼“å­˜
   - å®¢æˆ·ç«¯çŠ¶æ€æŒä¹…åŒ–

4. **è™šæ‹Ÿæ»šåŠ¨**
   - å¤§å‹ JSON æ•°æ®ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨

### 10.2 å®ç°ç¤ºä¾‹

```typescript
// åŠ¨æ€å¯¼å…¥
import dynamic from 'next/dynamic';

const MonacoEditor = dynamic(() => import('@monaco-editor/react'), {
  ssr: false,
  loading: () => <div>åŠ è½½ç¼–è¾‘å™¨...</div>,
});

const PDFViewer = dynamic(() => import('@/components/PDFViewer'), {
  ssr: false,
  loading: () => <div>åŠ è½½ PDF æŸ¥çœ‹å™¨...</div>,
});
```

## 11. æµ‹è¯•ç­–ç•¥

### 11.1 æµ‹è¯•ç±»å‹

- **å•å…ƒæµ‹è¯•**ï¼šå·¥å…·å‡½æ•°ã€éªŒè¯å™¨
- **ç»„ä»¶æµ‹è¯•**ï¼šReact ç»„ä»¶
- **é›†æˆæµ‹è¯•**ï¼šAPI è·¯ç”±
- **E2E æµ‹è¯•**ï¼šå®Œæ•´å·¥ä½œæµ

### 11.2 æµ‹è¯•å·¥å…·

- Jest + React Testing Library
- Playwright (E2E)
- MSW (API Mocking)

## 12. éƒ¨ç½²é…ç½®

### 12.1 Vercel é…ç½®

```json
// vercel.json
{
  "buildCommand": "pnpm build",
  "devCommand": "pnpm dev",
  "installCommand": "pnpm install",
  "framework": "nextjs",
  "regions": ["hkg1"],
  "env": {
    "NODE_ENV": "production"
  }
}
```

### 12.2 ç¯å¢ƒå˜é‡

```bash
# .env.local
NEXT_PUBLIC_APP_URL=http://localhost:3000
MAX_FILE_SIZE=52428800
UPLOAD_DIR=/tmp
```

## 13. å®‰å…¨è€ƒè™‘

1. **æ–‡ä»¶ä¸Šä¼ å®‰å…¨**
   - æ–‡ä»¶ç±»å‹éªŒè¯
   - æ–‡ä»¶å¤§å°é™åˆ¶
   - ç—…æ¯’æ‰«æï¼ˆå¯é€‰ï¼‰

2. **XSS é˜²æŠ¤**
   - å†…å®¹è½¬ä¹‰
   - CSP å¤´éƒ¨è®¾ç½®

3. **CORS é…ç½®**
   - é™åˆ¶å…è®¸çš„æº

4. **é€Ÿç‡é™åˆ¶**
   - API è°ƒç”¨é¢‘ç‡é™åˆ¶

## 14. ç›‘æ§ä¸æ—¥å¿—

```typescript
// src/lib/logger.ts
export const logger = {
  info: (message: string, meta?: any) => {
    console.log(`[INFO] ${message}`, meta);
  },
  error: (message: string, error?: any) => {
    console.error(`[ERROR] ${message}`, error);
  },
  warn: (message: string, meta?: any) => {
    console.warn(`[WARN] ${message}`, meta);
  },
};
```

## 15. æ–‡æ¡£è¦æ±‚

- README.mdï¼šé¡¹ç›®è¯´æ˜ã€å®‰è£…ã€ä½¿ç”¨
- API.mdï¼šAPI æ¥å£æ–‡æ¡£
- CONTRIBUTING.mdï¼šè´¡çŒ®æŒ‡å—
- ä»£ç æ³¨é‡Šï¼šJSDoc æ ¼å¼
